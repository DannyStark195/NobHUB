{% extends 'home.html' %} 
{% block title%}Nobhub chat{% endblock %}
{%block left_side%}
  <!-- Left Panel: Contacts & Buttons -->
  <div class="left-side chat-leftside light-theme">
            <div class="chat-header">
              <h1 class="title garamond-font">
                <!-- <ion-icon name="mail"></ion-icon> -->
                <ion-icon name="chatbubble-ellipses"></ion-icon>
                <i>Nobhub</i>
              </h1>
              <ion-icon name="menu-outline" class="menu-btn"></ion-icon>
                    <div class="menu light-theme">
                      <a href="/home" class="chat-link light-theme">
                        <div class="menu-options">
                            <ion-icon name="home-outline"></ion-icon>
                            <p>Home</p>
                        </div>
                      </a>
                      <a href="/profile" class="chat-link light-theme">
                        <div class="menu-options">
                            <ion-icon name="person-outline"></ion-icon>
                            <p>Profile</p>
                        </div>
                      </a>
                      <a href="/settings" class="chat-link light-theme">
                        <div class="menu-options">
                            <ion-icon name="settings-outline"></ion-icon>
                            <p>Settings</p>
                        </div>
                      </a>

                      <a href="/logout" class="chat-link light-theme">
                        <div class="menu-options red-clr">
                            <ion-icon name="log-out-outline"></ion-icon>
                            <p>Sign out</p>
                        </div>
                      </a>
                    </div>

                    <div class="add-contact">
                        <a href="/users"><ion-icon name="add"></ion-icon></a>
                    </div>
            </div>

                
  
    
      <div class="chat-main">

      <form action="/search" method="GET" >
        <input type="text" name="search" id="search" class="search-bar margin-inline-start middle-light-theme" placeholder="Search Nobhub" >
      </form>
            

    
    

  {% for contact in contacts %}
  {% if contact.contact_name in ['N.O.B', 'Dennis'] %}
    <a href="/chat/AI/{{ contact.id }}" class="chat-link middle-light-theme">
      <div class="contact">
        <img src="{{ url_for('static', filename=contact.contact_image_path) }}" class="contact-proile-pic", alt="Contact Profile Picture">
        <div class="">

          <p class="contact-name">{{contact.contact_name}}</p>
          <p class="contact-last-message">{{ decrypt_user_message(contact.last_message) }}</p>
        </div>
      </div>
    </a>
        {% else %}
    <a href="/chat/{{ contact.id }}" class="chat-link light-theme">
      <div class="contact">
        <img src="{{ url_for('static', filename=contact.contact_image_path) }}" class="contact-proile-pic", alt="Contact Profile Picture">
        <div class="">

          <p class="contact-name">{{contact.contact_name}}</p>
          <p class="contact-last-message">{{ decrypt_user_message(contact.last_message) }}</p>
        </div>
      </div>
    </a>
  {% endif %}
  {% endfor %}
  </div>
  </div>
  {% endblock %}

{% block right_side %}
<!-- Right Panel: Chat Area -->
<div class="right-side chat-rightside light-theme">
  <!-- Chat Header -->
  <div class="chat-header light-theme">
    <a href="/home" class="light-theme"><ion-icon name="arrow-back-outline"></ion-icon></a>
    <img src="{{url_for('static', filename=user_to_chatwith.user_image_path)}}" alt="Contact profile picture" />
    <p>{{user_to_chatwith.username}}</p>
  </div>

  <!-- Chat Body -->
  <div class="chat-main middle-light-theme" id="chat-messages">
    {% if messages %} {% for message in messages %} {% if message.user_id==
    user.id%}
    <div class="chat-message user-message">
      <ion-icon name="ellipsis-vertical" class="menu-btn position-left"></ion-icon>
      <div class="menu position-slightly-lower light-theme">
        <!-- inside user message menu: change edit form to point to get_edit_message (GET) or you can keep form as link -->
        <div class="menu-options">
          <form action="{{ url_for('routes.get_edit_message', id=message.id) }}" method="get" style="display:inline;">
            <input type="hidden" name="contact_id" value="{{ contact.id }}">
            <button type="submit" class="chat-link-btn light-theme">Edit</button>
          </form>
        </div>

        <div class="menu-options red-clr">
          <form action="{{ url_for('routes.get_delete_message', id=message.id) }}" method="get" style="display:inline;">
            <input type="hidden" name="contact_id" value="{{ contact.id }}">
            <button type="submit" class="chat-link-btn red-clr">Delete</button>
          </form>
        </div>
      </div>
      <p> {{ decrypt_user_message(message.message) }} </p>
      <time class="chat-message-time">{{ message.time.isoformat()+'Z' }}</time>
    </div>
    {% endif %} {%if message.user_id == user_to_chatwith.id %}
    <div class="chat-message contact-message light-theme">
      <ion-icon name="ellipsis-vertical" class="menu-btn position-left"></ion-icon>
      <div class="menu position-slightly-lower light-theme">
        <div class="menu-options red-clr">
          <form action="{{ url_for('routes.get_delete_message', id=message.id) }}" method="get" style="display:inline;">
            <input type="hidden" name="contact_id" value="{{ contact.id }}">
            <button type="submit" class="chat-link-btn red-clr">Delete</button>
          </form>
        </div>
      </div>
       <p>{{ decrypt_user_message(message.message) | safe }} </p>
      <time class="chat-message-time">{{ message.time.isoformat()+'Z' }}</time>
    </div>
    {% endif %} {% endfor %} {% else %}
    <!-- <div class="no-message-div"> -->
      <!-- <div class="no-message"> -->
        <!-- <h2 class="garamond-font">Select a contact to start chatting</h2> -->
        <!-- <p>No messages selected</p> -->
      <!-- </div> -->
    <!-- </div> -->

    {% endif %}
    <div id="typing-message-display" class="typing-message-display">
      <ion-icon name="ellipsis-horizontal-outline"></ion-icon>
      <ion-icon name="ellipsis-horizontal-outline"></ion-icon>
      <ion-icon name="ellipsis-horizontal-outline"></ion-icon>
    </div>
  </div>

  <form
    action="{% if user_to_chatwith.username in AIs %}/chat/AI/{{ contact.id }}{% else %}/chat/{{ contact.id }}{% endif %}"
    method="POST" id="message-form" class="chat-form">
    <input id="message-box" type="text" name="user_message" class="search-bar auto-grow" size="10" placeholder="Type a message..."
      required oninvalid="this.setCustomValidity('Can\'t send empty message')" oninput="this.setCustomValidity('')"
      autocomplete="off" />
    <button type="submit" class="chat-send-btn">
      <ion-icon name="send"></ion-icon>
    </button>
  </form>

{# remove the static .dark-overlay block and replace with: #}
{% if dark_overlay %}
  <div class="dark-overlay">
    <!-- EDIT OVERLAY -->
    {% if edit_overlay %}
      <div class="forms light-theme">
        <h2>
          <a href="{{ url_for('routes.chat', id=contact.id) }}"><ion-icon name="arrow-back-outline"></ion-icon></a>
          Edit message
        </h2>
        <form action="{{ url_for('routes.edit_message', id=edit_message_id) }}" method="POST" id="edit-message-form" class="chat-form">
          <input type="hidden" name="contact_id" value="{{ contact.id }}">
          <input id="edit-message-box" type="text" name="edited_message" class="search-bar edit-bar"
                 placeholder="Edit message..." required
                 value="{{ edit_message_text|default('', true) }}" autocomplete="on" />
          <button type="submit" class="chat-send-btn"><ion-icon name="send-outline"></ion-icon></button>
        </form>
      </div>
    {% endif %}

    <!-- DELETE CONFIRMATION OVERLAY -->
    {% if delete_overlay %}
      <div class="forms light-theme">
        <h2>
          <!-- <a href="{{ url_for('routes.chat', id=contact.id) }}"><ion-icon name="arrow-back-outline"></ion-icon></a> -->
          Delete message
        </h2>
        <p>Are you sure you want to delete this message?</p>

        <div class="side-by-side" style="margin-top:12px;">
          <a href="{{ url_for('routes.chat', id=contact.id) }}" class="chat-link-btn">No</a>

          <form action="{{ url_for('routes.delete_message', id=delete_message_id) }}" method="POST" style="display:inline;">
            <input type="hidden" name="contact_id" value="{{ contact.id }}">
            <button type="submit" class="chat-link-btn red-clr">Yes</button>
          </form>
        </div>
      </div>
    {% endif %}
  </div>
{% endif %}
</div>

<script src="{{ url_for('static', filename='scripts/socketio.js') }}"></script>

<script type="text/javascript">
  // Ensure socket.io client is loaded before this runs (home.html includes it)
  var socketio = io();
  socketio.on('connect', function(){ console.log('socket connected', socketio.id); });
  socketio.on('disconnect', function(){ console.log('Websocket disconnected'); });

  // Server-side values (rendered into JSON) so the JS is valid
  var userId = {{ user.id | tojson }};
  var userName = {{ user.username | tojson }};
  var contactId = {{ user_to_chatwith.id | tojson }};
  var IsAI = {{ (user_to_chatwith.username in AIs) | tojson }};

  // let theme = localStorage.getItem('theme')
  // Cache DOM nodes
  var messageDisplayDiv = document.getElementById('chat-messages');
  var messageBox = document.getElementById('message-box');
  var messageForm = document.getElementById('message-form');
  var typingIndicator = document.getElementById('typing-message-display');
  var messageContent;
  // Helper to append a message (message must be safe/escaped by server)
  const newMessage = (user_id, contact_id, username, contact_name, message, time) => {
    if (!messageDisplayDiv) return;
    const localDate = new Date(time);
    const options = {year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false};
    const formattedDateTime = localDate.toLocaleString(undefined, options);
    
    messageContent = `\n      <div class="chat-message contact-message light-theme">\n        <ion-icon name="ellipsis-vertical" class="menu-btn position-left"></ion-icon>\n        <div class="menu position-slightly-lower light-theme">\n          <div class="menu-options">\n            <p href="" class="edit-message"></p>\n          </div>\n          <div class="menu-options red-clr"></div>\n        </div>\n        <p>${message}</p>\n        <time class="chat-message-time"> ${formattedDateTime}</time>\n      </div>\n    `;
    if(theme=='dark'){
    messageContent = `\n      <div class="chat-message contact-message light-theme" style="color:#fff; background-color:#000000fd;">\n        <ion-icon name="ellipsis-vertical" class="menu-btn position-left"></ion-icon>\n        <div class="menu position-slightly-lower light-theme">\n          <div class="menu-options">\n            <p href="" class="edit-message"></p>\n          </div>\n          <div class="menu-options red-clr"></div>\n        </div>\n        <p>${message}</p>\n        <time class="chat-message-time"> ${formattedDateTime}</time>\n      </div>\n    `;
    
  }
    
    if(user_id === userId){
        messageContent = `\n      <div class="chat-message user-message">\n        <ion-icon name="ellipsis-vertical" class="menu-btn position-left"></ion-icon>\n        <div class="menu position-slightly-lower light-theme">\n          <div class="menu-options">\n            <p href="" class="edit-message"></p>\n          </div>\n          <div class="menu-options red-clr"></div>\n        </div>\n        <p>${message}</p>\n        <time class="chat-message-time"> ${formattedDateTime}</time>\n      </div>\n    `;
        if(theme==='dark'){
        messageContent = `\n      <div class="chat-message user-message" style="color: #000; background-color:#d6d6ddff;">\n        <ion-icon name="ellipsis-vertical" class="menu-btn position-left"></ion-icon>\n        <div class="menu position-slightly-lower light-theme">\n          <div class="menu-options">\n            <p href="" class="edit-message"></p>\n          </div>\n          <div class="menu-options red-clr"></div>\n        </div>\n        <p>${message}</p>\n        <time class="chat-message-time"> ${formattedDateTime}</time>\n      </div>\n    `;
        console.log(theme)
        }
    }

    messageDisplayDiv.insertAdjacentHTML('beforeend', messageContent);
    messageDisplayDiv.scrollTop = messageDisplayDiv.scrollHeight;
  };

  // Incoming message from server
  socketio.on('send-message', (data) => {
    newMessage(data.user_id, data.contact_id, data.username, data.contact_name, data.message, data.time);
  });

  // Submit handler: server-side POST for AI chats, socket for normal chats
  if (messageForm && messageBox) {
    messageForm.addEventListener('submit', (event) => {
      if (IsAI) {
        // Allow normal form POST so the server AI route handles and responds
        return;
      }
      event.preventDefault();
      const messageContent = messageBox.value.trim();
      if (!messageContent) return;
      socketio.emit('send-message', {data: messageContent});
      messageBox.value = '';
      if (messageDisplayDiv) messageDisplayDiv.scrollTop = messageDisplayDiv.scrollHeight;
    });
  }

  
  // Convert UTC message timestamps already printed to local times
  document.addEventListener('DOMContentLoaded', function(){
    if (messageDisplayDiv) messageDisplayDiv.scrollTop = messageDisplayDiv.scrollHeight;
    const timeElement = document.querySelectorAll('.chat-message-time');
    timeElement.forEach(element => {
      const utcTimestring = element.textContent.trim();
      const localDate = new Date(utcTimestring);
      const options = {year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false};
      element.textContent = localDate.toLocaleString(undefined, options);
    });
  });
</script>

{% endblock %}


